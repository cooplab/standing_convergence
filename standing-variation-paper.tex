\documentclass{article}
\usepackage{fullpage}
\usepackage{amsmath,amssymb}
\usepackage[authoryear]{natbib}
\usepackage{marginnote}
\usepackage{graphicx}
\usepackage{hyperref}
%\usepackage{latexml} % for \iflatexml
\usepackage{color}
\usepackage[dvipsnames]{xcolor}
\usepackage[utf8]{inputenc}  % for special characters in authors' names

\newcommand{\gc}[1]{{\it\color{blue}#1}}
\newcommand{\mfp}[1]{{\it\color{red}#1}}
\newcommand{\plr}[1]{{\it\color{Fuchsia}#1}}

\usepackage{lineno}  %%%% FOR AMNAT
\newcommand{\var}{\mathop{\mbox{Var}}}
\renewcommand{\P}{\mathbb{P}}
\newcommand{\E}{\mathbb{E}}
\newcommand{\R}{\mathbb{R}}

%\usepackage{setspace}
%\doublespacing

%\iflatexml  % no margin notes in latexml
% \newcommand{\marginnote}[1]{}
%\newcommand{\marginnote}[1]{{\it\color{red}(#1)}}
%\fi

\bibliographystyle{amnat}



\title{The role of standing variation in geographic convergent adaptation}
\author{
Peter L. Ralph$^{*,1}$ \\ email: pralph@usc.edu  
\\and\\
Graham Coop$^{*,2}$ \\ email: gmcoop@ucdavis.edu 
}


\begin{document}


\maketitle
\date{}

\begin{center}

    $^*$ These authors contributed equally to this work. \\
$^1$ Computational Biology and Bioinformatics \\ 
University of Southern California, Los Angeles, CA \\
$^2$ Center for Population Biology \& Department of Evolution and Ecology \\ 
University of California -- Davis, Davis, CA, 95616\\
\end{center}

% standing deleterious variation
% higher mutation rate => more importance of standing
% G6PD a combination of new and standing
% interpolates betw panmixia and 2010
% pleiotropy pre-shift biases adaptation
% establishment phase
% selective sweeps and species coherence, gene flow

\linenumbers
\modulolinenumbers[2]

\section*{Abstract}
The extent to which populations experiencing shared selective pressures
adapt through a shared genetic response
is relevant to many questions in evolutionary biology. 
In a number of well studied traits and species, 
it appears that convergent evolution within species is common. 
In this paper, 
we explore how standing, genetic variation contributes to
convergent genetic responses in a geographically spread population,
extending our previous work on the topic.
Geographically limited dispersal slows the spread of each selected allele,
hence allowing other alleles 
-- newly arisen mutants or present as standing variation -- 
to spread before any one comes to dominate the population. 
When such alleles meet, their progress is substantially slowed 
-- if the alleles are selectively equivalent, 
they mix slowly, dividing the species range into a random tessellation,
which can be well understood by analogy to a Poisson process model of crystallization. 
In this framework, 
we derive the geographic scale over which a typical allele is expected to dominate, 
the time it takes the species to adapt as a whole,
and the proportion of adaptive alleles that arise from standing variation.
Finally, we explore how negative pleiotropic effects of alleles before an environment change 
can bias the subset of alleles that contribute to the species' adaptive response. 
We apply the results to the many geographically localized G6PD
deficiency alleles thought to confer resistance to malaria, \mfp{where the large
mutational target size makes it a likely candidate for adaptation
from standing variation, despite the selective cost of G6PD
deficiency alleles in the absence of malaria.}
We find the numbers and geographic spread of these alleles matches our predictions reasonably well,
\mfp{consistent with the view that they arose from a combination of} 
standing variation and new mutations since the advent of malaria.
Our results suggest that much of adaptation may be geographically local 
even when selection pressures are homogeneous. 
\mfp{Therefore, we argue that caution must be exercised when arguing that strongly
geographically restricted alleles are necessarily the outcome of local adaptation.}
We close by discussing the implications of these results for 
ideas of species coherence and the nature of divergence between species. 


%%%%%%%% %%%%%%%%%%%%
\section{Introduction}

There are an increasing number of examples where
different populations within a species have
adapted to similar environments by means of independent genetic changes. 
In some cases this convergent evolution \mfp{is the result of quite
distinct genetic changes, involving very different genes and pathways,} despite shared selection pressures; 
in other cases independent adaptations are identical down the same
nucleotide change
\citep{Jeong20141,stern2013genetic,MartinOrgogozo:13, Conte2012}. 
Such convergent evolution within populations has been seen for many
carefully studied phenotypes across a range of species, 
including drug resistance in pathogens,
resistance to pathogens or pesticides,
and the molecular basis of pigmentation changes.
The phrase ``parallel evolution'' is also used to refer to such convergent evolution;
here we use these synonymously, 
as we are concerned with adaptation within a single
species that can occur via a different or shared genetic routes \citep[see][for more discussion]{Arendt:08}.

The issue of convergent adaptation within species touches on a number
of important questions in evolutionary biology. 
These include the extent to which adaptation is shaped by pleiotropic constraints \citep{Haldane:book,Orr:05},
whether adaptation is mutation-limited \citep{Bradshaw:91,karasov2010}, 
and to \mfp{what degree species should be regarded} as cohesive units. 
Convergent evolution also affects our ability to detect adaptation from population genomic data,
since no single allele sweeps to fixation over the entire area affected by the selection pressure \citep{softsweepsIII}.

Convergent evolution can occur even within a well mixed population
subject to a constant selection pressure, 
either through selection on multiple mutations present as standing variation within the population
before selection pressures switch \citep{Orr:01,softsweepsI},
or due to multiple adaptive alleles that arise after selection pressures switch \citep{softsweepsII}. 
Previous work has shown that 
a primary determinant of the probability that multiple alleles contribute to adaptation
is the product of the population size and the mutation rate \citep[see][for a review]{MesserPetrov}. 


Spatial population structure,
as caused for example by geographically limited dispersal, 
also increases the chance of convergent evolution. 
For example, 
\gc{geographically patchy} selection pressures can lead to much higher probability of parallel adaptation than uniform pressures,
since alleles are unable to spread through intervening populations
\citep{RalphCoop:14}. 
In \citet{ralphcoop2010} we formulated a simple model of \gc{convergent adaptation in 
a spatially spread population with local dispersal
that is exposed to some novel, spatially homogeneous selection pressure.
We assumed that a single mutational change was sufficient to adapt
the population after the change in environment. Under this assumption,
selected alleles arise and spread locally, as shown in Figure \ref{fig:sim-spread}. 
If the geographic area is large enough multiple selected alleles can
arise independently and spread before any one has spread across all of space. 
A somewhat analogous situation also
arises in spatial models of clonal inference in asexuals \citep{gordo_adaptive_2006,martens_interfering_2011,otwinowski_clonal_2014}.}



\begin{figure}[ht]
  \begin{center}
    \includegraphics[width=\textwidth]{sims/Peter_sims.png}
  \end{center}
  \caption{
{\bf Simulation of the geographic spread of new mutations}. Simulation
on a grid of $101 \times 101$ populations with 100 haploid individuals
in each, showing spread of a beneficial allele with advantage $s=0.1$.
Times are in numbers of generations, with probability of mutation per
generation 0.3. Different colours show the different independent
origins and spreads of selected alleles. Alleles quick establish and
start to spread, but because they are selective equivalent once they
spread into each other they only mix slowly (note the lack of change
from generation 600 onward). More details of the
simulation are given in \citet{ralphcoop2010}. 
}
  \label{fig:sim-spread}
\end{figure}


\gc{Under this model we previously derived} the characteristic geographic scale over which 
multiple instances of the adaptive allele are expected to arise in parallel, 
a characteristic length \mfp{expressed in terms the parameters of interest.} 
\gc{In \citet{ralphcoop2010} we assumed that there was no standing variation for the adaptive
allele (e.g., because the allele was very strongly deleterious before the environmental change)}, 
so that parallel mutation must be due to multiple new mutations occurring after the environmental shift. 

In this paper, we extend this spatial model to include standing variation 
present at mutation-selection balance before the selection pressures switch.
Below,
we show that convergent adaptation within a widespread species is likely to be
common \gc{when ranges, population sizes, or mutational targets are large}, as has already been seen for a number of traits. 
On this basis we argue 
that the genetics of adaptation may often be geographically local \gc{even
when selection pressures are geographically broad}, 
% and that we should expect to see relatively few wide-spread sweeps even when selection pressures are wide-spread. 
and that widespread selective sweeps \mfp{should tend to occur only}
when adaptation is highly constrained (e.g.\ by small mutation rate or
the need for a linked combination of alleles).
We discuss the \gc{history, and implications,} of this view for the evolutionary
coherence of species and molecular evolution.

%%%%%%%%% %%%%%%%%%%%% %%%%%%%
\subsection{Model description}

% selection pressure changes at $t=0$ from $1-s_d$ to $1+s_b$ -- homogeneous

We assume that the species range
is a large, homogeneous, one-- or two--dimensional region. 
There are two selective classes -- the \gc{\textit{ancestral}} type,
and the {\em mutated} type \gc{(which will offer a fitness benefit after the
environmental switch)}.
We assume that separately arising mutations are distinguishable --
either as selectively equivalent mutations, or by linked \gc{neutral} variation.
\gc{We assume that all alleles of the mutated type are selectively
equivalent (both in terms how deleterious they were before, and how
advantagous they are after, the environmental shift). 
Note that these mutations do not have to arise at the same locus,
just that they are selectively equivalent:
these could be mutations arising at the same base pair, 
or knockout mutations of any one of a number of genes in a pathway,
as long as carrying at least one of these alleles
is sufficient to adapt an individual to the new environment.}

We also suppose that 
the mutated type has been at a selective disadvantage 
for a sufficiently long enough time in the past to be at selection-mutation equilibrium,
but at a certain time the selective regime changes, so that the mutated type has a selective advantage and quickly spreads to fixation.
After fixation, alleles are either descended
from families of mutants present as standing variation when the selective regime changed,
or from new mutants arising since that time.

For concreteness, suppose that before time $t=0$,
the mutant type has fitness $1-s_d$ relative to the neutral type
(i.e.\ it produces on average $1-s_d$ times the number of offspring per generation),
and that after time $t=0$,
the mutant type has fitness $1+s_b$,
where $s_b>0$ will usually be assumed to be small, and $0<s_d<1$.
We assume that diploid fitness is additive, or at least that the
important early dynamics are determined by the heterozygous fitness, with no reference to the fitness of the
homozygote for the mutant alleles. \mfp{Note that this means that we
  are ignoring the case of totally recessive alleles.}
\gc{We assume that the variance in offspring number is one, see
  \cite{ralphcoop2010} for how this assumption can be relaxed.}
%The number of offspring has finite variance, 
%which would divide the probability of establishment of advantageous alleles below,
%but to keep the formulas simpler we assume to be equal to one.
As for the other parameters,
suppose that each offspring of a neutral parent is of the mutant type with probability $\mu$,
and that the mean squared geographic distance between parent and child
is $\sigma^2$. \mfp{We assume that the dispersal kernel is
  not heavy tailed, i.e., falling into the Gaussian domain of attraction, see \citet{ralphcoop2010} for
  discussion of heavy tailed kernels and \citet{hallatschek_acceleration_2014} for recent progress
  on rapid spreading due to very long distance dispersal.}
The species occupies an area with mean density
$\rho$ of alleles per unit area \gc{(twice the number of diploid
  individuals per unit area)}.

%We assume that dispersal occurs by local movement of
%individuals. Specifically we will assume that individuals dispersal a
%normally distributed distance, with the mean squared distance between parent and child is $\sigma^2$
%(i.e.\ $\sigma$ is the dispersal distance)

% Branching-process-sized point mass approx. to local groups present at $t=0$
% -- depends on local population density large enough relative to migration (to be "branching")
% -- and migration not too large (since we approximate as a point mass).
% Find mean density of clusters of successful standing mutants. 
% Is greater-than-one size of clusters likely to make a difference? 

\paragraph{Rates of origination of standing and new mutations}
We make use of the commonly used approximation that neglects competition between close relatives,
treating the offspring of a new mutant that appears in an area not already occupied by the mutated type
as a branching process \gc{in continuous time, measured in generations
(average parental age at birth)}. 
After $t=0$, the offspring of each individual mutant thus forms (approximately) a branching process with growth rate $s_b$,
so each new mutant establishes locally with probability $p_s \approx 2s_b$.
As in \cite{ralphcoop2010}, each new offspring has a very small probability of being a mutant and establishing locally,
so the collections of times and locations at which mutants appear and establish locally 
is well--approximated by a Poisson process in space and time.
\gc{By this we mean that there is a constant rate across space and
  time at which new
  mutations arise, and the occurance of new mutations in any region of
  space-time is independent of that in non-overlapping intervals
  in which the mutated type has not already appeared.}
The rate of this Poisson process,
i.e.\ the mean number of new mutants per unit area and per generation that
appear and establish locally after $t=0$ in areas not already occupied by the mutant type,
\plr{is the product of the haploid population density, denoted $\rho$,
the mutation rate ($\mu$),
and the probability of fixation $p_s$, or}
approximately 
\begin{equation}
\lambda = 2 s_b \mu \rho 
\end{equation}
\gc{In geographic areas already occupied by the mutant type, 
 new mutations are effectively neutral, and so unlikely to establish over the
 short-time scales considered here, and are hence excluded.  }

Before $t=0$, on the other hand, the allele is deleterious.
The genetic descendants of each new mutation are (with high probability) doomed to extinction,
but may persist for \mfp{a short} time (note that we have assumed that $s_d$ is not too small).
\gc{The} times and locations of new mutations before $t=0$ also \gc{will} be 
well--approximated by a 
Poisson process with rate $\mu \rho$ % PLR: this is not required, and depends on the units you measure area in: (if $\mu \rho \ll 1$) 
\gc{since mutations are rare events. Therefore,} 
the locations of all mutant families extant at $t=0$ whose descendants are destined to fix locally is 
a thinning of the original process, 
and so, by the Poisson Mapping Theorem, is also a Poisson process.
\mfp{We define $\lambda_0$ to be the mean density of this process, 
i.e., the geographic density
of standing variants that are present and escape loss when the
environment shifts.}
% (In principle, more than one member of a mutant family may fix,
% but we assume these are close together enough that we may treat them as beginning from a single point.)
If we assume that the descendants of at most only a few members of any extant mutant family at $t=0$ will survive,
and that these progenitors are near to each other in space, 
we can then treat each such family as equivalent to a single new mutation,
but with somewhat larger probability of local establishment,
\gc{following the environmental shift}.
(This approximation will be good 
if the logarithm of the size of each extant family is small relative to the establishment time,
\plr{since then new families quickly ``catch up'' to the size of already-extant families,}
and the spatial distribution of each is small relative to the spread between the families.)
To find $\lambda_0$, consider a mutation that arose \plr{$T$ generations ago}, 
and let \gc{$Z_T$ be the number of its descendants at time $0$}.
At time $t=0$, when the environment shifts, there are $Z_T$ individuals present with the mutation,
and each has probability $p_s$ of establishing, approximately independently.
Therefore, the probability that at least one descendant of this mutation establish and fix locally is $1-(1-p_s)^{Z_T}$,
% so defining $\zeta(u,t) = \E[u^{Z_t} | Z_0=1 ]$ to be the generating function of $Z_T$,
the mean number of clusters of standing variants destined to fix locally, per unit area, is
\begin{align*}
    % \mu \rho \int_0^\infty \left( 1- \zeta(1-p_s,T) \right) dT .
    \mu \rho \int_0^\infty \E\left[1- (1-p_s)^{Z_T}\right] dT .
\end{align*}
For $s_b$ small, using $p_s \approx 2s_b$ and that $\E[Z_T]=(1-s_d)^T$,
\plr{we know that $\E[(1-2s_b)^{Z_T}] \approx 1-2s_b \E[Z_T] = 1-2s_b (1-s_d)^T$,}
resulting in the approximation
\begin{align}
    \lambda_0 &= \mu \rho \int_0^\infty 2s_b (1-s_d)^{T} dT \\
        &= \frac{ 2 \mu \rho s_b }{ -\log(1-s_d) } .\\
        & =  \frac{\lambda }{ (-\log(1-s_d)) }.
\end{align}
Note that for small $s_d$ this can also be found by taking the expected frequency under mutation-selection
balance $\mu/s_d $ \citep{Haldane:27,Haldane:37} multiplying it by the
population density to obtain the expected number of chromosomes per unit area
carrying the deleterious allele, with each of these having a
probability $2s_b$ of escaping loss \citep[an analogous approach to
that taken by ][]{Orr:01}
. 

\paragraph{Geographic spread of alleles} 
Once an allele has become locally established it can begin to spread across space. 
We assume that the allele, once established, 
quickly settles down to spread spatially as a traveling wave of constant speed. 
The behavior of this wave of advance of a beneficial allele was first described by 
\citet{fisher1937wave} and \citet*{KPP1937}. 
Under reasonably general conditions, the speed of advance of this wave is $v = \sigma \sqrt{2s}$. 
See \citet{ralphcoop2010} for a more thorough review of these travelling waves.
Note that the speed of the wave will vary
with details of the space that individuals migrate across
\citep[e.g.\ see ][ for comparisons to migration on discrete grids]{Slatkin-speed:76,SlatkinCharlesworth:78}.

\paragraph{Putting it together.}
Now, we can put these ingredients together for a simple model of the geographic spread of alleles, 
a cartoon example of which is shown in Figure \ref{fig:cartoon}. 
Initially, when the selection pressures change at $t=0$, 
a set of standing variants can start to spread having escaped loss through drift. 
The originating mutations of these variants are depicted by lightning bolts, and occur at a density $\lambda_0$ across space. 
They spread at velocity $v$, carving out cones in space-time. 
As these alleles proceed in their geographic spread, other new alleles can arise and become established in parallel, 
whose origins are indicated by stars.
These new mutations arise and become established at rate $\lambda$.

As we outlined in \citet{ralphcoop2010}, this model of
geographic convergent evolution, when $\lambda_0=0$, is analogous to a model of crystallization due to \citet{kolmogorov-crystallization}.
In this model, nucleation sites form at random at a constant rate in time and space 
and initiate the radial growth of new crystals. 
After their initial spread, the different orientations of crystals form a random tessellation of space,
whose properties have been studied by \citet{moller92,moller95} and others \citep{bollobas-crystallization,gilbert-crystallization}. 
The generalized version of this process, for non-constant wave speeds
and inhomogeneous Poisson processes is known as the 
Kolmogorov--Johnson--Mehl--Avrami tessellation \citep{fanfoni-tomellini}.
Our combined process with both standing variation and new mutation is
a special case of the KJMA tessellation, 
where the spatial-temporally homogeneous Poisson origination process of new mutations, 
is supplemented by a single pulse of origination points at time zero with spatial density $\lambda_0$.
(For the purposes of analogy, we could imagine that before time $t=0$
the temperature is high enough that nucleation sites appear but do not persist long.)

If we ignore the effects of new mutation,
then everything about the process is relatively simple:
each point in space will be first reached by the wave whose origination point lies closest to it.
This random tessellation of space is known as a Poisson-Voronoi tessellation \citep{Moller:94}
(i.e.\ the cells formed by assigning regions of space to the nearest point in a Poisson process).
The properties of this tessellation by alleles is
determined by the spatial locations of the initiation points, 
which are sampled from a spatially homogeneous Poisson process, 
independent of the rate of spatial spread. 
Introducing new mutations cause some qualitative changes
beyond dependence on new parameters:
the cells formed by a Voronoi tessellation have straight sides,
but the introduction of new mutations cause these to curve
\citep[because the radii of the colliding circles differ; see Figure 1 of ][ for a graphical depiction of this point]{ralphcoop2010}.


\begin{figure}[ht]
  \begin{center}
    \includegraphics[width=\textwidth]{spreading_alleles_trimmed_2}
  \end{center}
  \caption{
{\bf Cartoon space-time diagram of the geographic spread of standing and new mutations}. 
Time runs down the page, and a single spatial dimension runs across the page. 
The environment switches at $t=0$, 
following which adaptive alleles that successfully escape loss by drift
spread locally from both standing variants (lightning bolts) and new
mutations (stars). \gc{(Note that the standing variants arose at times
prior to $t=0$.)}
The mean spatial density of successful standing variants at $t=0$ is $\lambda_0$,
and the mean density in (space $\times$ time) of successful new mutations is $\lambda$.
These successful alleles spread spatially outwards at speed $v$, 
so the space-time profile of their spread forms a cone. Any mutation
that arises in an area already within a cone will not have a selective advantage.
When these adaptive alleles meet, 
their rapid advance is halted because they no longer have an advantage,
so their boundaries form straight lines on short time-scales 
(over longer time-scales, they will mix into each other). 
\gc{One of the ways we derive various results in the text is by taking a
space-time point $(x,t)$ and asking the probability that no successful
alleles have spread there yet.} The grey dashed line shows a cone radiating backward in space-time,
originating at $(x,t)$, with slope $v$; its radius at $t=0$ is $v t$. 
This shows the location $x$ is not yet adapted at time $t$ because no successful alleles appear within this grey cone.
}
  \label{fig:cartoon}
\end{figure}


%%%%%%%%% %%%%%%%%%%%

\subsection{G6PD example}

Below we describe a number of properties of our process, but we will first introduce 
a motivating example to provide some concrete
numbers to use for illustrative purposes.

Over roughly the past ten thousand years, alleles conferring resistance to malaria have arisen in a number of genes 
and spread through human populations in areas where malaria \mfp{has been} endemic \citep{Kwiatkowski:05}. 
A number of these alleles appear to be examples of convergent adaptation, 
as different derived mutations in the same gene are seen in different individuals.
For example, 
a number of changes that confer malaria resistance have been observed in the $\beta$-globin gene;
and the sickle cell allele may plausibly have arisen by up to five independent occurrences
of the same base pair mutation at different locations within Africa
\citep{Flint:98,ralphcoop2010}.
Another particularly impressive case of convergent evolution \mfp{is presented by} the numerous changes throughout the X-linked G6PD gene, 
with upward of 50 polymorphic variants (above $1\%$ local frequency) having so far been described 
that lower the activity of the enzyme \citep{Howes-g6pd-variants,Minucci-g6pd}. 
These alleles are now found at a combined frequency of around 8\% frequency in malaria endemic areas,
rarely exceeding 20\% \citep{Howes-g6pd-preval}. 
Whether these all confer resistance to malaria is unknown,
but malaria is thought to be the primary driver of these polymorphisms
\citep[see][ for a general review]{hedrick2011population}.
Three G6PD deficiency alleles are particularly common and relatively well studied: 
the $A-$ allele found in much of sub-Saharan Africa; 
the Med allele found in the Mediterranean and Middle East; 
and the Mahidol allele found Myanmar and Thailand.
\mfp{ 
The protective effects of these G6PD alleles are complicated, and are likely heterogeneous
across study populations and the form of malaria considered
\citep[see ][ for recent discussion]{manjurano_2015, malaria_network_2014}.  
The $A-$ and Mahidol alleles are thought to offer some protective effects against {\it Plasmodium falciparum} and {\it P.\ vivax} in both
heterozygote females and/or hemizygote males \citep{Ruwende-g6pd,
  Louicharoen-g6pd, manjurano_2015}. }
Haplotype-based analysis of genetic diversity surrounding
$A-$, Med, and Mahidol suggest that they have spread over the past 
few thousand years \citep{tishkoff-g6pd,Slatkin-age-est,Saunders-g6pd,Louicharoen-g6pd}, 
consistent with the age of other known malaria resistance alleles. 
Population genetic analyses suggest that these three variants each have a hemizygote/heterozygote 
selection coefficient of $0.05-0.3$
\citep{tishkoff-g6pd,Slatkin-age-est,Saunders-g6pd,Louicharoen-g6pd}. 
This is in reasonable agreement with the selection coefficients calculated by
\citet{Ruwende-g6pd} on the basis of the present day levels of
resistance to malaria due to the $A-$ allele. \\

%although it is unclear if this selective pressure alone suffices to maintain the polymorphism 
%in the face of the considerable malaria resistance advantage)

%leading to hemolytic anemia when exposed to a variety of compounds, notably those present in fava beans 


Given \mfp{such strong selection the alleles} should have risen
quickly to fixation, so their presence at intermediate frequency,
over a broad geographic area, makes it a good candidate for a recently
balanced polymorphism due to heterozygote advantage \citep[note that
the conditions for a balanced polymorphism are
complicated by the hemizygosity of males, see][]{hedrick2011population, Pamillo:1979}. 
Indeed, hemizygous males and homozygous females suffer from G6PD deficiency,
and homozygote females may also not be protected against malaria \citep{manjurano_2015, malaria_network_2014}. 
The theory we use regarding the ``wave of advance'' \citep{fisher1937wave}
applies as well in the case of heterozygote advantage
\citep{aronson1975nonlinear}, with the selected allele spreading
locally to the equilibrium frequency (rather than fixation). 
Therefore, our framework is applicable to the spread of G6PD, with speed determined by the advantage of heterozygotes when rare.
We assume that before malaria became prevalent, 
G6PD deficiency alleles suffered a decrease in relative fitness of $s_d$ in heterozygote and homozygotes females and hemizygote males. 
Assuming that the underlying causes and strength of this drop in fitness have not changed, 
we estimate that $s_d$ has to have been upward of $\sim 0.05$ (if $s_b \geq 0.05$),
in order to have resulted in the equilibrium frequency seen today in
areas with endemic malaria \citep[based on heterozygote advantage
calculations for the X chromosome, results not shown, see also][]{Ruwende-g6pd}. 

%Hedrick sex-specific review http://www.eeslmu.de/eeswiki/images/Hedrick_Review.pdf
% Fry: http://www.ncbi.nlm.nih.gov/pmc/articles/PMC3654548/
% kidwell http://www.ncbi.nlm.nih.gov/pmc/articles/PMC1213615/
%Rice: http://www.jstor.org/discover/10.2307/2408385?uid=3739560&uid=2129&uid=2&uid=70&uid=4&uid=3739256&sid=21103992458511



% G6PD frequency across world http://www.google.com/imgres?imgurl=http%3A%2F%2Fwww.plosmedicine.org%2Farticle%2Finfo%3Adoi%2F10.1371%2Fjournal.pmed.1001339.g002%2Flargerimage&imgrefurl=http%3A%2F%2Fwww.plosmedicine.org%2Farticle%2Finfo%253Adoi%252F10.1371%252Fjournal.pmed.1001339&h=2938&w=2381&tbnid=oD_tX3ea8IbLfM%3A&zoom=1&docid=k37axqAZDS7ljM&ei=5rdOU5TVDMqj8QGntICYBg&tbm=isch&ved=0CF8QMygLMAs&iact=rc&uact=3&dur=1447&page=1&start=0&ndsp=15

% Spatial distribution of G6PD alleles:  http://www.malariajournal.com/content/12/1/418

%IDEA: could we look at all freq. reports of g6pd and see if male and
%female freq. diffs support model of sexual-conflict?

The geographic area of Central and Eastern Asia with malaria is 
on the order of ten million square kilometers.
In that area there are at least $15$ common, \plr{clinically relevant} variants \citep[see Figure \ref{fig-G6PD-map}, from][]{Howes-g6pd-variants}. 
\plr{(These are type 2 variants that express at ${}<50\%$ enzyme activity, 
predispose individuals to haemolytic anaemia, 
and are found in at least 10 localities;
see \citet{Howes-g6pd-variants} for more details.)}
Therefore, the average width of an area occupied by an allele is $\sqrt{10^7/15} \approx  800$km. 
The coding region of G6PD is 515 codons long, 
and around 140 distinct deficiency alleles have been observed. 
Assuming a mutation rate of $\approx 10^{-8}$ per base pair per generation, 
we can take as an order-of-magnitude estimate $\mu \approx 10^{-6}$ per generation. 
The dispersal and demographic parameters of humans in the past few thousand years is unclear,
particularly as we are concerned with the ``effective'' population density
(i.e.\ population density divided by variance in offspring number).
We therefore will use two reasonable values for the effective population density: $\rho=2$ and $0.2$ people per km$^2$,
and three values for the dispersal distance: $\sigma=10$, $50$ and $100$ kilometers per generation.
Clearly, human migration has been shaped both by local dispersal and larger-scale expansions 
\citep[see][for a recent discussion]{Pickrell:14}, 
so these parameters only provide a rough view of the process.

\begin{figure}[ht]
\begin{center}
  \includegraphics[width=1.0\textwidth]{G6pd_Howes_et_al_1475-2875-12-418-4}   %{charlen-by-sd-limit}
\caption{ 
{\bf Map of G6PD-deficiency allele frequencies across Asia.} 
The pie chart shows the frequency of G6PD-deficiency alleles. 
The size of the pie chart indicates the number of G6PD-deficient individuals sampled.
Countries with endemic malaria are colored yellow. 
Figure taken from \citet{Howes-g6pd-variants}
\url{http://www.malariajournal.com/content/12/1/418}. 
} \label{fig-G6PD-map}
\end{center}
\end{figure}

% \begin{figure}[ht]
% \begin{center}
%   \includegraphics[width=1.0\textwidth]{G6PD_charlengths}
% \caption{ %
% {\bf Characteristic length,} as a function of dispersal distance $\sigma$ and selective disadvantage $s_d$.  XXX at what parameters. XXX
% } \label{Fig-G6PD-charlength}
% \end{center}
% \end{figure}

%$A-$ ?? risk lower of severe malaria for both female heterozygotes and male
 %hemizygotes estimates of selection pressure \citep {Ruwende-g6pd}
%Mahidol487A \citep{Louicharoen-g6pd}
%Show's effect in het and homozy females


%Selection coefficient (s) 	A- 0.044 (0.019–0.048)  Med	0.034
%(0.014–0.049)  ``The mean age of the A- allele in these runs was 6357 years, with a 95\% credibility interval extending from 3840 to 11,760 years. For the Med alleles, the mean age was 3330 years with a 95\% credibility interval of 1600 to 6640 years"
%\citet{tishkoff-g6pd}
%s 0.24 and t= 40 generations \citep{Slatkin-age-est}
%The estimated age is ~100 generations with an upper bound of <150
%generations A- 0.1 < s < 0.2 \citep{Saunders-g6pd}
%Mahidol487A mutation started to increase at ~1500 YBP, with a
%selection intensity of ~0.23 \citep{Louicharoen-g6pd}
%Shows effect in het and homozy females


%%%%%%%%%%%% %%%%%%%%%%%%%%%

\subsection{The geographic resolution of adaptation from new and standing variation}

% a characteristic length of regions and a proportion of haplotypes (or of space?) that are from standing variation

In \citet{ralphcoop2010}, studying the model without standing variation,
we defined a {\em characteristic length} which gave the spatial scale across which mutants with distinct origins would establish.
This was proportional to the mean distance between neighboring established mutants,
but had the advantage of being easier to calculate.
Furthermore, the time scale over which adaptation occurred could be found by dividing the characteristic length 
by the speed at which the mutants spread.
We first define a similar characteristic length for this new model. %,
%as well as a similar compound parameter describing the relative importance of standing variation to the process of adaptation.
%(Note that a similar approach, summarizing with a {\em characteristic
%length} was taken by \citep{slatkin1973geneflow} for a different
%problem.)


Suppose we fix our attention on a particular new mutation that happens to be the first to occur in some region.
If it does not encounter other locally fixed, beneficial mutants,
it will cover a distance $L$ in time $L/v$. \gc{In doing so (in two-dimensions) it will have
started from a point in space and spread out to cover a circular geographic region of area $\pi L^2$.
The cylinder in space-time with this circle as a base and
height $L/v$ has volume of this cylinder is $\pi L^2 \times (L/v)$.
Therefore, the number of other successfully established mutations that
would have appeared} in the circle it has covered up until this time is Poisson with mean
$\lambda_0 \pi L^2 + \lambda \pi L^3 /v$ in two dimensions
(and $2 \lambda_0 L + 2 \lambda L^2 /v$ in one dimension).
% $\lambda_0 \omega_d L^d + \lambda \omega_d L^{d+1} /v$ in $d$ dimensions
Therefore, if we define $\chi$ for a two-dimensional model to be the unique positive solution to
\begin{equation} \label{eqn:chi_def_1}
    \lambda_0 \pi \chi^2 + \lambda \pi \chi^3 /v = 1,
\end{equation}
then $\chi$ gives the distance spread unobstructed by the descendants of a new mutant
before it is expected that one other successful mutation would have arisen in the area covered so far.
The explicit formula for $\chi$ in two dimensions \gc{can be found by
rearranging eqn. \eqref{eqn:chi_def_1} but is cumbersome;} here we omit
it. \gc{In one dimension things are a little prettier} and the characteristic length is $\chi = ( \sqrt{\lambda_0^2 + 2 \lambda/v} - \lambda_0 )/( 2 \lambda / v )$.
Substituting expressions for $\lambda_0$, $\lambda$, and $v$ from above,
\gc{in two-dimensions} we can rewrite eqn. \eqref{eqn:chi_def_1} as
\begin{equation} \label{eqn:defines_chi}
%    \left( \frac{ - \chi \log(1-s_d) }{ 2 s_b \sigma } \right)^2 + \left( \frac{ - \chi \log(1-s_d) }{ 2 s_b \sigma } \right)^3 
%        = \frac{ - \log(1-s_d)^3 }{ 4 s_b^2 \sigma^2 \pi \rho \mu } .
   \frac{\sqrt{2s_b} }{-\log(1-s_d) } \chi^2 + \frac{1}{\sigma} \chi^3 = \frac{1}{\sqrt{2s_b} \rho\mu\pi}
\end{equation}
From this we see that $\chi$ decreases with $\rho$ and $\mu$.
Furthermore, for large $\sigma$, the characteristic length \gc{approaches
the value we would obtain just} from standing variation:
\begin{equation} \label{eqn:chi_standing}
\chi = \sqrt{ -\log(1-s_d) / 2 s_b \rho \mu \pi } + O(1/\sigma).
\end{equation}
On the other hand, if the mutant allele is highly deleterious before $t=0$,
\gc{then standing variation is} unimportant the characteristic length is \gc{approaches} the value from \citet{ralphcoop2010}:
\begin{equation} \label{eqn:chi_new}
\chi = ( \sigma / \rho \mu \pi \sqrt{2 s_b} )^{1/3} + O(1/\log(1-s_d)).
\end{equation}
These two end points help build our intuition for the interaction of
parameters in shaping the geographic scale of convergent evolution.
By the above calculation, we know that the relevant mutations occur about distance $\chi$ apart, 
 and occur within the first $\chi/v$ generations.
 Said another way, if we look in a circular region of space of radius $\chi$ over $\chi/v$ generations,
 we expect to find roughly one mutational origin.

%XXX could do calculations as in "panmixia" here, e.g.\ if $f = (\chi \sqrt{\pi \lambda_0})^2$ then
%$f = 1-\gamma f^{3/2}$, where
%$\gamma = (4 \pi^{5/2} / \sqrt{2}) \mu^2 s_b^{3/2} \rho^2 / \sigma \log(1/(1-s_d))$.
%Then if $\gamma \ll 1$, $f \approx 1$, while if $\gamma \gg 1$, then $f \approx 0$.

%%%GRAHAM: I commented this out. We return to do proportion standing
%%%below, so perhaps nicer to restrict that to one place. 
% By the above calculation, we know that the relevant mutations occur about distance $\chi$ apart, 
% and occur within the first $\chi/v$ generations.
% Said another way, if we look in a circular region of space of radius $\chi$ over $\chi/v$ generations,
% we expect to find one mutational origin;
% we denote the probability that this mutation is from standing variation by $\pi_0$.
% Therefore, $\pi_0$ is roughly the proportion of establishing mutations that come from standing variation,
% and it is an property of competing Poisson processes that
% \begin{align} \label{eqn:pizero}
%     \pi_0 = \lambda_0 \pi \chi^2 .
% \end{align}
% (In one dimension, $\pi_0 = 2 \lambda_0 \chi$.)


In Figures \ref{Fig-G6PD-charlength} and \ref{Fig-G6PD-charlength-sb}, we show the range of characteristic lengths as a function 
of various parameters chosen to match the evolution of malaria
resistance at G6PD. 
These curves match our intuition that \gc{higher} population densities result in
smaller characteristic lengths (as would higher mutation rates). 
Allowing standing variation increases \gc{the 
input of new alleles} and so decreases the characteristic length below that predicted
by only new mutations (i.e.\ equation \eqref{eqn:chi_new}, \citet{ralphcoop2010}).
In turn, increasing the prior deleterious effect of the allele ($s_d$)
acts to increase the
characteristic length until it reaches that predicted by new mutation alone. 
Higher dispersal distances lead to larger characteristic lengths, 
since more rapid geographic spread block other mutations from establishing. 
A larger selective advantage ($s_b$) acts in two conflicting
ways: aiding the rapid geographic spread of established alleles, and also helping more independent copies
\mfp{to} escape drift and become established. 
The effect of helping\gc{locally} establish alleles wins out, since increasing the selective benefit $s_b$ decreases the characteristic length. 
 (This can be shown in general by differentiating \eqref{eqn:defines_chi} with respect to $z=\sqrt{s_b}$,
showing that $\partial_{z} \chi = - ( C_1 z \chi + C_2 \chi^2 )/(C_3 z^2 + C_4 z \chi ) \le 0$ for appropriate nonnegative constants $C_{1-4}$.) 
This effect is strongest when only standing variation contributes ($s_b^{-1/2}$, equation \eqref{eqn:chi_standing}), 
as in that case the speed of spread does not matter \mfp{only the
  initial density of established alleles after the environmental shift}. 
The dependence of the characteristic length on $s_b$ when only new
mutations contribute is much weaker (\gc{of order} $s_b^{-1/6}$, equation \eqref{eqn:chi_new})
Overall, the range of characteristic lengths observed are reasonably
consistent with the average diameter of a G6PD variant in Eurasia of
800km, especially for the lower population density, as long as the
fitness cost of G6PD-deficiency alleles before malaria ($s_d$) was \mfp{high}. 

Note that the conflicting roles of $\rho$ and $\sigma$ mean that even in
species where levels of neutral differentiation are low, geographic
convergent adaptation may be common. This is because low levels of
neutral genetic differentiation between geographic regions can be due to high population
densities rather than high dispersal distances, and high population
densities would allow convergent adaptation. As such geographic convergent
evolution may be common even in species with little neutral population structure.

\begin{figure}[ht]
\begin{center}
  \includegraphics[width=1.0\textwidth]{G6PD_charlengths}   %{charlen-by-sd-limit}
\caption{ %
{\bf Characteristic length, in kilometers, as a function of selective disadvantage}, 
compared to the corresponding quantity without standing variation (equation \eqref{eqn:chi_new}) 
and to the quantity only considering standing variants (equation \eqref{eqn:chi_standing}).
The other parameters are chosen to match those of G6PD,
\gc{$\mu = 10^{-6}$} and $s_b = 0.05$. As the characteristic length with
only standing variation is independent of dispersal distance it is
plotted as a single black dotted line. 
} \label{Fig-G6PD-charlength}
\end{center}
\end{figure}

\begin{figure}[ht]
\begin{center}
  \includegraphics[width=1.0\textwidth]{G6PD_charlengths_sb}   %{charlen-by-sd-limit}
\caption{ %
{\bf Characteristic length}, in kilometers, as a function of selective advantage, at two population densities,
holding the prior disadvantage of the allele fixed at $s_d=0.05$ and the mutation rate fixed at \gc{$\mu=10^{-6}$}.  
We compare this to the corresponding quantity without standing
variation (equation \eqref{eqn:chi_new}) 
and to the quantity only considering standing variants (equation \eqref{eqn:chi_standing}).
} \label{Fig-G6PD-charlength-sb}
\end{center}
\end{figure}


% \begin{figure}[ht]
% \begin{center}
%   \includegraphics[width=1.0\textwidth]{charlen-by-sd-sigma}
% \caption{ %
% {\bf Characteristic length,} as a function of dispersal distance $\sigma$ and selective disadvantage $s_d$.  XXX at what parameters. XXX
% }
% \end{center}
% \end{figure}

%%%%%%%%%%% %%%%%%%%%%%%% %%%%%%%%%
\subsection{Time to adaptation}

It is also straightforward to compute the mean time until adaptation.
\gc{Imagine a geographic location, and let $\tau \ge 0$ be the time at
which this location} is first reached by some advantageous mutation.
Then, as can be seen from the
perspective of the grey dot in Figure~\ref{fig:cartoon}, 
$\tau > t$ if and only if the cone with point at $(x,t)$ and slope $v$
extending back to $t=0$ (light grey dashed lines) is empty of
successful mutations. Since we assume that \mfp{successful alleles} arise as a Poisson process, 
in two dimensions
\begin{equation} \label{eqn-no-mut-t}
    \P\{ \tau > t \} = \exp\left( - \lambda_0 \pi v^2 t^2 - \lambda \pi v^2 t^3 / 3 \right) ,
\end{equation}
i.e., the combined probability that area of a circle of radius $vt$ surrounding our
point at $t=0$ was free of successful standing variants, and no
successful, new mutations arose in the cone (that has radius $r=vt$ at
$t=0$ and height $h=t$, and hence volume $\pi r^2 h/3$). 
Since $\E[\tau] = \int_0^\infty \P\{ \tau > t \} dt$,
\begin{align}
    \E[\tau] % &= \int_0^\infty \P\{ \tau > t \} dt \\
        &= \int_0^\infty \exp\left( - \lambda_0 \pi v^2 t^2 - \lambda \pi v^2 t^3 / 3 \right) dt.
\end{align}
\gc{For applications we evaluate this integral numerically. }  %For means of evaluating this integral, see Appendix \ref{apx:integrals}.


In Figure \ref{G6PD_chartimes} we show the mean time until adaptation
for various values of the parameters chosen to match the case of
adaptation at G6PD. Increasing $\sigma$ and decreasing $s_d$ lower 
the time to adaptation, as alleles spread geographically more quickly
and are present as standing variation more often
respectively. Increasing $s_b$ strongly decreases the time to
adaptation, as it both causes more alleles to escape drift and to
rapidly spread. Given that the G6PD alleles likely spread over a few
thousand years, i.e.\ less than a few hundred generations, 
this time scale seems quite plausible, except perhaps for the lowest dispersal distances.  



\begin{figure}[ht]
\begin{center}
  \includegraphics[width=1.0\textwidth]{G6PD_chartimes_sd_sb.pdf}   %{charlen-by-sd-limit}
\caption{ %
{\bf Mean adaptation times} as a function of \gc{selective advantage and disadvantage.}
We compare these to the corresponding quantities without standing variation and only considering standing variants.
} \label{G6PD_chartimes}
\end{center}
\end{figure}



% proportion of haplotypes (and of space) that are from standing variation 

\subsection{The contribution of standing variation.}
We can also ask in our framework to address what proportion of new adaptive variants arise from standing variation.
We have defined $\lambda_0$ to be the mean density
of standing variants that are present and escape loss when the
environment shifts.
We will define $\gamma$ to be the mean density of newly arising alleles
that spread having arisen in an area free of other adaptive alleles.
Since the probability that a mutant arising at location $x$ and time $t$ 
is lucky enough to be born in a location not already occupied by mutants
is $\P\{ \tau > t \}$,
\gc{we can see  $\gamma = \int_0^\infty \lambda \P\{\tau>t\} dt$, and hence
$\gamma = \lambda \E[\tau] $.}
%Using that $\lambda_0 = \lambda / \log(1/(1-s_d))$, this gives us that
%\begin{equation}
 %   \nu_+ = (\mbox{mean density of new patches}) = \frac{1}{1-\log(1-s_d) \E[\tau]} .
%\end{equation}
Therefore, the mean proportion of \gc{adapted} patches that come from standing variation
is 
\begin{equation} \label{prop_patches_standing}
\lambda_0 / (\lambda_0 + \gamma)  = \frac{1}{1-\log(1/(1-s_d)) \E[\tau]} ,
\end{equation}
using the fact that $\lambda_0 = \lambda / \log(1/(1-s_d))$.
% this gives us the exact quantity we approximated by $\pi_0$ in \eqref{eqn:pizero}.
There are $\lambda_0 + \gamma$ patches per unit area, so
the typical patch (informally, the patch around a randomly chosen
successful mutation; formally, drawn from the Palm measure
\citep{cox1980point}) occupies area $1/(\lambda_0 + \gamma)$. 

We can also find the mean proportion of space covered by standing
variants (we will restrict ourselves to two dimensions).
At time $t$ a geographic location has not yet been reached by the
mutation with probability given by equation \eqref{eqn-no-mut-t}.
\mfp{Given that it has not been reached by $t$, the probability} that it will be reached by time $t+dt$ 
by a standing variant is approximately $2 \lambda_0 \pi v^2 t dt$,
which is $\lambda_0$ multiplied by the thin slice of extra area in our
expanded circle at $t=0$, which has gone from a radius $vt$ to
$v(t+dt)$. The corresponding probability that the point is reached by a new
variant is 
$\lambda \pi v^2 t^2 dt$, which is $\lambda$ multiplied by the
sliver of  extra volume in our space-time cone at time $t+dt$ compared to that at time $t$.
Therefore, the mean proportion of space covered by standing variants,
is
\begin{equation} \label{prop_space_standing}
    z_0 = \int_0^\infty {2 \lambda_0 \pi v^2 t} \; \exp \left( -
      \lambda_0 \pi v^2 t^2 - \lambda \pi v^2 t^3 / 3 \right) dt,
\end{equation}
\mfp{this is the probability a given location is reached first by a
standing variant (which follows from competing our two exponential
waiting times).}
\gc{For applications we evaluate this integral numerically.}
%To evaluate this integral, again see Appendix \ref{apx:integrals}.
%\marginnote{put in this value in terms of Gaussian CDF?}

Furthermore, if we define $a_0$ to be the mean area occupied by a typical standing variant, 
then $a_0$ is given by the proportion of the range occupied by standing variants divided by the mean density of unique standing variants,
i.e.\ $a_0 = z_0 / \lambda_0$.
We can solve for $a_+$, the corresponding mean area occupied by a given new variant, 
using the formula $a_0 / a_+ = z_0 / (1-z_0)$.

In Figure \ref{G6PD_standing_var_proportion} we show the proportion of
alleles that spread from standing variation, and the proportion of
geographic space covered by standing variants for parameters chosen to match our G6PD example.
Even for relatively large deleterious costs prior to the environmental switch, 
standing variants still make up quite a large proportion of the adaptive alleles, 
and an even larger proportion of the range 
(they \mfp{occupy a larger area than new mutations, since they get a head start}).

\begin{figure}[ht]
\begin{center}
  \includegraphics[width=1.0\textwidth]{G6PD_standing_var_proportion}
\caption{ %
{\bf Mean proportion of patches arising from standing variation,} 
\plr{as a function of selective disadvantage, at two population densities.}
The parameters given are for the G6PD example.
Both panels show the expected proportion of patches that
arise from standing variation (dotted lines, equation \eqref{prop_patches_standing}),
and the expected proportion of
geographic space that is covered by adaptation from standing variation
(solid lines, equation \eqref{prop_space_standing}).
We set $\mu=10^{-5}$ and $s_b=0.05$ to match our G6PD example.} \label{G6PD_standing_var_proportion}
\end{center}
\end{figure}


%{\tt Simulations:} 
%compare mean density against $s_d$ at different values of $\sigma$; 
%omit variability if needed for readability. 
%Compare to panmictic results.


\subsection{Multiple variant types}
Another problem that we can address with this work is
the extent to which pleiotropy biases 
adaptation towards the repeated use of particular subset of loci
(i.e.\ convergence at genetic level). 
While many alleles may confer the beneficial phenotype, 
not all will contribute equally to adaptation if they have negative pleiotropic consequences.
There are at least two ways that negative pleiotropy can contribute to high rates of convergence 
when adapting if a single change is sufficient for adaptation. 
First, negative pleiotropic effects can reduce 
the overall beneficial selection coefficient of an allele in the new environment,
making them unlikely to become established and slow to spread 
(and in the worst case making them deleterious). 
This first effect has been well studied by a number of authors
\citep{Orr:00,Otto:04,WelchWaxman:03,Chevin:10} and its role in genetic
convergence examined \citep{Orr:05,Chevin:10,Unckless:09}. 
A second contribution is that alleles that have
less negative pleiotropy are more likely to be present as standing variation 
before the environmental shift, and so are more able to respond
immediately.

Here we focus primarily on the second effect. 
Let's imagine for the moment \plr{that there are several classes of beneficial allele,}
all having the same beneficial selection coefficient 
(\gc{or} at least that beneficial selection coefficients are similar enough that our selective exclusion
approximation holds over the time scale on which we examine the process).
Each class of mutations $j$ has its own mutation rate $\mu_j$ and selective disadvantage $s_{d,j}$ prior to the environmental switch. 
As they have the same beneficial selection coefficient after the switch, 
all of the waves travel outward at a rate $v$. 
Then, the density of type $j$ standing variants per unit area 
and the input rate of \textit{de novo} variants per unit area per generation are, respectively,
\begin{align}
  \lambda_{0,j} = \frac{ 2 \mu_j \rho s_b }{ -\log(1-s_{d,j}) } \qquad \text{and} \qquad    \lambda_{j} = 2 \mu_j \rho s_b .
\end{align}
Using these rates, and an argument analogous to that used to derive
equation \eqref{prop_space_standing},
at the time when every location has been reached by an adaptive allele,
the proportion of the species range covered by alleles of type $j$ is
\begin{equation} \label{eqn-prop-space-allele-j}
    p_j = \int_0^\infty  \left( 2 \lambda_{0,j} \pi v^2 t +  \lambda_j \pi v^2 t^2 \right)  
    \; \exp \left( - \sum_k ( \lambda_{0,k} \pi v^2 t^2 + \lambda_k
      \pi v^2 t^3 / 3 ) \right) dt .  %%deleted \lambda_j \pi v^2 t^3
                                %%out of term out front
\end{equation}
If we only allow standing variation this collapses to 
\begin{equation}  \label{eqn-prop-space-allele-j-standing-room-only}
    p_j = \frac{  \mu_j / \log(1-s_{d,j}) }{\sum_k  \mu_k / \log(1-s_{d,k}) } ,
\end{equation}
while if we only allow new variation, 
i.e.\ if all variants are highly deleterious before the environment switches, 
 $p_j =\mu_j / (\sum_k  \mu_k)$.

To illustrate some of the properties of this model, 
let's imagine the somewhat extreme scenario in which there is a single base pair 
at which a possible mutation is relatively free of negative pleiotropy (call this class $1$);
and a larger mutational target where changes 
have more serious pleiotropic consequences in the ancestral environment (class $2$). 
We set $s_{d,1} \leq s_{d,2}=0.05$ and $\mu_1=1 \times 10^{-8}$, 
assume that both classes share a beneficial selection coefficient of $s_b=0.05$,
and think of the second class of alleles as arising at one of ten, one hundred, or one thousand base pairs. 
We show the expected proportion of space covered by
the rarer, class $1$ mutations in Figure \ref{fig:pleiotropy_calc}.
\mfp{As expected intuitively,} the contribution of the rarer mutation decreases as the
mutational target of the second class becomes larger, and as the
difference in the negative pleiotropic consequences of the two classes of alleles decreases. 
The case with standing variation only is the best case scenario 
for the rarer mutation, so its rate of introduction after $t=0$ is necessarily lower. 
However, the standing-variation-only case does seem to provide a
reasonable rule of thumb, especially for parameter combinations, 
such as high population densities and high dispersal distances, 
that increase the contribution of standing variation (and similarly for high $s_b$). 

It is natural to also incorporate differences in the beneficial selection coefficients of the different classes of alleles, 
to allow for negative pleiotropic effects acting to suppress the advantage of an allele once the environment switches.
One simple way to do this is to simply replace $s_b$ with $s_{b,j}$ 
resulting in a class-specific new allele establishment rates ($\lambda_{j}$) and rates of spread ($v_j$).
These then could be used in equation \eqref{eqn-prop-space-allele-j}. 
For instance, we could extend the two class model above 
so that class one has the additional advantage of $s_{1,b}>s_{2,b}$. 
This would further increase the contribution of the rarer class,
because this class would both overcome drift more often and spread more rapidly. 
However, a straightforward application of the logic of used to construct equation \eqref{eqn-prop-space-allele-j}
fails once the different allelic types meet,
since the assumption of selective exclusion no longer holds:
alleles with higher $s_b$ will spread, at a lower speed, into regions occupied by alleles with lower $s_b$.
Given enough time, the most advantageous type (type 1, in this case) would spread everywhere, 
and so substituting multiple values for $s_b$ in equation \eqref{eqn-prop-space-allele-j}
would only provide a short-term approximation to a longer term dynamic. 
Even if the initial tessellation has formed with purely class 2 alleles, 
the first allele would have a selective advantage $\delta s =s_{b,1}-s_{b,2}$,
and so would arise at rate $2\rho \mu_1 \delta s $ and would spread at speed $\sigma \sqrt{\delta s}$. 
An extension of our Poisson process model could incorporate these effects, 
by thinning the Poisson process of establishing mutations by correctly,
but is considerably less tractable.
Whether allele $2$ persists would depend on the linkage arrangements between loci. 
If the loci underlying allele 1 and 2 are unlinked, then allele 1 can spread without disrupting allele 2. 
However, if they are linked, the spread of allele $1$ may push allele $2$ out of the population. 
More complicated dynamics,
including spatial Dobzhansky-Muller incompatibilities \citep{Kondrashov:03,ralphcoop2010} 
could ensue if there are epistatic interactions between the alleles. 

% An extension of this Poisson process model could incorporate these
% effects, thinning out mutations  
% It could be interesting to investigate pleiotropy's combined
% effect of adaptation, through standing variation and rate of spread, by coupling together
% $s_{b,k}$ and $s_{d,k}$ perhaps through Fisher's geometric model.
% Using Fisher's geometric model we could allow $s_{b}$ and $s_d$ to be coupled as a consequence of being an
% the fitness in two related environments of some underlying phenotype
% drawn from a continuous distribution,
% rather than our $k$ discrete classes \citep{Chevin:10}.  

%While it may be of interest to explore this model
%incorporating both effects of negative ple

\begin{figure}[ht]
\begin{center}
  \includegraphics[width=1.0\textwidth]{pleiotropy_calc}
\caption{ %
{\bf Proportion of space covered by rarer but less negatively pleiotropic
  mutation}. Empty circles give the result for standing variation only,
  equation \eqref{eqn-prop-space-allele-j-standing-room-only}. Lines give
  the result allowing both standing and \textit{de novo} mutations (equation \eqref{eqn-prop-space-allele-j}).
  Here we hold $s_b=s_{d,2}=0.05$ and $\mu_1=1 \times 10^{-8}$.
  }   \label{fig:pleiotropy_calc}
\end{center}
\end{figure}


\subsection{Local establishment and comparison to panmixia}

In the above, we have assumed that once the mutation appears,
conditional on eventual fixation, it begins to spread spatially at speed $v$ instantly,
effectively neglecting the time it must first spend escaping demographic stochasticity.
In \citet{ralphcoop2010} we addressed this by noting that there would be no change at all in our results 
if all mutations had to wait the same amount of time before fixing locally,
and that this time was short relative to the time it took the wave to spread across the characteristic length;
we then showed via simulation that this was reasonable in certain situations.
In this section we examine this assumption in more detail, although mostly through heuristic arguments,
and also compare the results above to the results without geographic structure of \citet{softsweepsII}.

We are assuming that shortly after a new mutation appears, 
it can be approximated by a branching process growing at rate \gc{$s_b$}
until the point that it grows large enough to ``feel'' spatial structure,
at which point it begins to spread as a more--or--less deterministic wave.
Although we are not aware of good analysis of this transition, 
the relevant size \gc{of the branching process} when spatial structure becomes important
should be something close to $\sigma^2 \rho$ 
(i.e.\ Wright's ``local effective population size'', \citet{Wright:43}).
Let $Z_t$ be a continuous-time branching process with $Z_0=1$ and $\E[Z_t] = e^{s_b t}$.
Then we know that there exists a random variable $W$ such that $\lim_{t\to\infty} e^{-s_b t} Z_t = W$ almost surely,
so that if $\tau$ is the time $Z_t$ reaches size $\sigma^2 \rho$, % i.e.\ $\tau = \inf\{ t \ge 0: Z_t > \sigma^2 \rho\}$,
then $\sigma^2 \rho = Z_\tau \approx e^{s_b \tau} W$ \citep{jagers1975branching}.
From this we know that $\tau \approx (1/s_b) (\log (\sigma^2 \rho) - \log W)$;
although more detailed information is available (e.g.\ a central limit theorem for $\tau$, \citet{nagaev1971limit}),
we will stick to the loose interpretation.

So, roughly speaking, we need to evaluate the importance of a delay of about $T = (1/s_b) \log (\sigma^2 \rho)$.
New mutations will appear and become established during this time if
$2 \rho \sigma^2 \mu s_b \ge 1/T$,
i.e.\ if $2 \rho \sigma^2 \mu \ge 1/\log (\sigma^2 \rho)$.
Our model will still be a good approximation, however, 
as long as $T$ is short relative to the time a wave takes to spread between nearby mutational origins.
This can be worked out,
but it is simpler to note that if the converse is true 
\mfp{(i.e., that reaching local fixation is slow compared to the spread of the wave)}, 
the process is largely unaffected by spatial structure,
and so the panmictic model is a good approximation for the true process.
%Since both our spatial model and the panmictic model underestimate the true degree of parallel adaptation,
%it suffices to compare results from the two models to avoid applying the wrong model.

% When would we expect more mutations in this time?
% Roughly, if populations are larger than $C/\mu$ for some $C \approx 100$.
% Compare to panmixia: increases degree of parallel mutation if... ?

\citet{softsweepsII} show that under a panmictic model with certain assumptions on the parameters,
the number of independent origins due to both standing variation and new mutation seen in a sample of size $n$
has approximately the Ewens distribution with parameters $n$ and $\theta = 4 N \mu$.
As $n$ increases, the total number of types seen grows as $\log n$.
In our model, we can increase total population size by increasing either the density $\rho$ or the total amount of area.
In either case, the predicted number of distinct types grows linearly with $n$,
much faster than under panmixia.

The results of \citet{softsweepsI} and \citet{softsweepsII} suggest that in a
panmictic population the number of independent alleles (and their frequencies) in a sample
is nearly independent of $s_b$ and $s_d$  \citep[although this
breaks down with fluctuating population size,
][]{Wilson-softsweep}. In the panmictic model the
lack of dependence on $s_b$ comes about because while increasing $s_b$
increases the rate at which independent mutations become established,
it also accelerates the frequency gain of established alleles, 
hence decreasing the time period in which new alleles can arise and hope to be at significant frequency in the population. 
These two effects \mfp{approximately} cancel each other out leading to no strong effect of $s_b$ on the number of independent alleles. 
Decreasing $s_d$ increases the number of standing variants within a population, 
increasing the number of alleles that manage to establish and spread from standing variation \citep{softsweepsI,Orr:01}. 
However, having more established standing alleles
acts to exclude the spread of new alleles that arise once the environment switches. 
These two opposing effects again cancel out, leading to little overall
effect of $s_d$ on the number of independent alleles.
In contrast, our results show that the characteristic length 
(closely related to the density of independent alleles) 
depends on both $s_b$ and $s_d$ in a geographically spread population. 
Like the panmictic model, in our model, alleles also act to exclude each other; 
however, the geographic spread of an allele is slow compared to the initial exponential growth of an allele in a panmictic population. 
That means that the role of selection in helping
alleles become established can dominate, leading to more independent origins, both by
being  weaker before and stronger after the environmental switch. 

% We could compare the probability of parallel adaptation under the two models (see eq'n 18 in \citet{softsweepsII}),
% but this seems less useful than an assessment of the degree of parallel adaptation.


\section{Discussion}

When the geographical area where a species experiences a 
selection pressure is greater than our characteristic
length we expect multiple independent alleles to arise and
spread in that area. Our results suggest that convergent evolution
among populations may be quite common, \gc{at least when population
densities and mutational target sizes are not too small, and dispersal is
limited across the range.  While considering smaller mutational
target sizes (e.g., less than the 100bp in our example) or lower population densities would lower the probability of convergence
within a given geographical area, it would also act to considerably lengthen
the time to adaptation. In such cases adaptation may simply fail to
occur at all or populations may adapt via some other means (e.g., by using a
broader mutational target). 
}

\gc{Our inclusion of standing variation 
before environmental change greatly increase the probability of
convergence within a species.}
While at face value this increase seems unsurprising,
this relationship differs markedly from the case of multiple competing
alleles in a panmictic population \citep[see discussion above and in ][]{softsweepsI,softsweepsII}. 
Importantly, allowing standing variation may greatly lower the time until the species becomes adapted 
across the geographic range of the selection pressure. We have also
shown that adaptation through standing variation biases the type of variation towards those alleles 
with fewer pleiotropic effects, since these are more common as standing variation before the environmental shift. 
This bias can in some cases easily overcome quite significant differences in mutational target sizes
among loci allowing the same locus to be repeatedly the source of
adaptation even if there are seemingly many different routes to adaptation.
(See Figure~\ref{fig:pleiotropy_calc}.)

\paragraph{The confusing signal of geographic convergent evolution.}
As we have argued in \citet{ralphcoop2010} the ease with which
geographic convergent adaptation occurs means that we should
incorporate it more widely into our thinking about the genetic basis
of adaptation. For example, the absence of European skin pigmentation alleles in
ancient DNA from Europeans who lived several thousand years ago
has led to the suggestion that these individuals had dark
pigmentation \citep{olalde2014derived,lazaridis2013ancient, Wilde2014}. 
However, given our results and the partially convergent
basis of skin pigmentation between Europeans and East Asians
\citep{norton-human-pigmentation,edwards2010pigmentation} it seems just as plausible that these ancient individuals
adapted to high latitudes via a different complement of ``light-skin'' pigmentation alleles;
to our knowledge, we have no strong evidence either way.
Such convergence may considerably complicate the 
exploration of phenotypes and adaptation among populations using variants mapped in a
limited set of populations \citep{Berg:14}.

More generally, if geographic convergence is common, we should often expect to see
selected alleles that are strongly geographically restricted as they
have simply not had time for neutral gene flow to spread them across the
landscape. \gc{Such convergent alleles will be $F_{ST}$-outliers compared to
  older neutral variation, untill there is sufficient time for
  migration to smooth out them out across the landscape.}
This pattern may be very hard to distinguish from local adaptation using population genomic approaches
alone. This is especially problematic as boundaries between convergent alleles may often
occur where gene flow rates are low, i.e.\ historical and ecological breaks, even if
the alleles concerned have no bearing on the ecological differences
across these breaks \citep[see][for a wide-ranging discussion of how allelic differentiation may build along particular zones]{bierne2011coupling}. 
We are rarely so fortunate as to know as much about the genetics, phenotypic distributions, 
and potential selection agents as we do for malaria resistance in humans. 
Therefore, we must be wary of mistaking the strange spatial distributions of particular alleles 
for adaptation to some very specific selection pressure (e.g.\ the distribution of the Mahidol allele in Figure \ref{fig-G6PD-map}), 
when they are simply elements of a larger geographic mosaic of alleles responding to a broadly shared selection pressure. 

%In cases, such as G6PD, where we have a relatively clear understanding of the genetics and
%phenotypic consequences we can avoid confusing the convergent response   

Each of these local sweeps will be associated with the haplotype on which the particular allele arose. 
Under the parameter regime we study,
standing variants are still quite young, 
so we do not expect a strongly reduced hitchhiking effect. 
As such, following the initial period of
adaptation, we should expect the population to be partitioned into a
set of geographically restricted long haplotypes. 
Given sufficient time these haplotypes will mix together through
migration and drift, 
potentially leading to a \mfp{within population} signal of a sweep from multiple independent
mutations if our selected allele occurs at the same locus \citep{softsweepsIII}, 
or to multiple partial sweeps if the loci are scattered across the
genome \citep{CoopRalph:12}.


Our results are predicated on the idea that adaptive variants are
initially rare within populations, i.e.\ they are reasonably
deleterious before the environment switches. \mfp{ In contrast, if they adapt via common variation even distant populations could have
a shared basis of adaptation, e.g.\ previously neutral (or nearly neutral) variation, shared among populations. 
If many loci contribute to variation in a trait, then
selection on any one allele may be weak, 
which might lead adaptation to use the same alleles in different populations.
However, sufficiently differentiated populations may still
adapt via different genetic routes, as the constellation of alleles
that respond to selection quickest will be somewhat different due to
drift among populations} \citep{Barton:89}.
% best positioned to initially respond to positive selection, 
% i.e.\ those at intermediate frequency, will be somewhat different. 
Therefore, it may be the case that polygenic traits are even less susceptible to a shared
genetic basis to adaptation across populations than simple traits.   
However, we currently lack good models and methods with which to test this.
% models of this, and our ability to infer
% such shared events means that empirically an answer for this question
% may be limited for the moment.

%%Mayr: [t]he steady and high genetic input caused by gene flow is the main factor responsible for genetic cohesion among the populations of a species.

\paragraph{Are species held together by widespread selective sweeps?}
Our results touch on an old debate on the evolutionary coherence of species. 
Mayr and many others have argued that species are coherent
evolutionary units because they are united by shared gene flow \citep[pages 521--522 in][]{Mayr:SpeciesEvol}. 
However, this argument has been questioned by a number of authors 
based on relatively high levels of differentiation, and low rates of dispersal, in many species \citep{EhrlichRaven:69,Levin:79}.
Even if gene flow is not high enough to prevent neutral differentiation or local adaptation, 
a number of authors have argued that species are cohesive 
if gene flow is high enough for globally selected alleles 
(and their hitchhiking haplotypes)
to spread across entire species 
\citep[see also][]{Rieseberg2001,MorjanRieseberg:04,Ellstrand2014}.
At present, large scale genotyping and sequencing projects, 
along with more sophisticated methods, 
are highlighting ever more signals of gene flow between populations and species \citep{Patterson:12,SousaHey:13,Hellenthal:14}.
However, our work on geographic convergent adaptation
\citep[see also][]{ralphcoop2010,RalphCoop:14} 
suggests that species should often adapt to
widespread selection pressures through convergent evolution rather
than waiting for a single allele to migrate across the range. 

% over length-scales determined by our characteristic length.
 
In support of this idea, putative recent selective sweeps seem to often be geographically restricted \citep{Pickrell:09,Coop:09,Granka:14},
rather than species-wide \citep[but see][ for a potential example]{Clark:07,Long:13}. 
This is likely in part due to the relatively low incidence of widespread selection pressures,
but as noted above even when we know of widespread selection
pressures (e.g.\ malaria) the response is usually convergent, not shared, across large spatial scales. 
On the other hand, 
introgression of adaptive alleles across species and sub-species boundaries, 
suggests that selected alleles do sometimes spread despite low
migration rates \citep[see ][ for a recent review]{hedrick2013adaptive}.
However, at least some of these cases 
may be caused by introgression of haplotype complexes
consisting of many, tightly linked, beneficial alleles (that perhaps
are inaccessible by mutation over reasonable time-scales for a population in a new
environment).  
Currently we can only scan genomes for species-wide sweeps
in those few organisms with population-scale sequence data, 
and so we do not know if these observations generalize to most species.
This is rapidly changing,
and will allow us to form a much improved picture of the relationship 
between the level of neutral population structure, 
and the age and geographic spread of selected alleles across many species.

%%Graham: I feel that this moved things in an interesting but
%%tangential direction. Also I think that introgression may reflect
%%earlier environmental exposure of populations. I t

%% Interesting point but felt like we were 
%The important missing piece to these puzzles seems to be an understanding
%of when phenotypes are accessible to mutation to a given species,
%and why they may be accessible to one subspecies and not another.


% Other cases of selective introgression
% are concurrent with populations spreading into new environments,
% and coming in contact with preadapted populations, potentially
% lessening the chance of convergent adaptation \citep{}.

Even if selective sweeps only bring alleles to fixation locally,
they are still potentially a stronger homogenizing force
than neutral mixing through migration.
Under neutral mixing, the mean number of generations back to the most recent common ancestor
is on order of the total effective population size.
This quantity has not been worked out for a model with simultaneous local sweeps,
but will be somewhat analogous to the ``spatial $\Lambda$-Fleming--Viot'' models of \citet{barton2013modelling},
in which local sweeps occur independently across the range.
Lineages that are \gc{closely linked to the sweeping allele} ($\sim v/\chi$ Morgans) will be moved
towards the center of the sweep (a displacement $O(\chi)$), 
and pairs of lineages caught up in the same sweep could be forced to coalesce 
\citep[see ][for work on geographic
hitchhiking]{barton2013genetic}. In this case lineages and alleles are literally
hitchhiking across space.
The overall rate of lineage movement and coalescence
depends on the rate of sweeps, their geographic scale, and the rate of recombination,
and could be calculated by combining the result presented here with
\citet{barton2013modelling} and \citet{barton2013genetic}. 
However, if geographic sweeps are common
then this may substantially speed up the rate of mixing compared to
neutral drift and migration. 

% In these models, the mean number of generations back to the most recent common ancestor for distant samples
% scales with XXX,
% which can be substantially shorter.
% \plr{Maybe I'm forgetting something in their papers -- did they do this? --
% but I think it would be a little bit of work to figure out what parameters to put into their models.}
% Intuitively, we can obtain this as follows:
% suppose that coalescence only occurs during local sweeps,
% which occur at rate $\lambda$
% on a spatial scale such that there are on average $M$ independent origins of the sweep during each bout of adaptation.
% The motion of lineages backwards is not dissimilar to a stepping-stone model with $M$ sites
% that coalesce when they are in the same deme
% with probability dependent on the recombination distance to the sweeping, selected site.
% The mean hitting time of two independent random walks on a graph with $M$ nodes is of order $M$;
% to get the mean number of generations until coalescence, 
% we must divide this by the probability of remaining linked to the selected site as it sweeps
% and by the frequency of selected sites.
% Since $M$ scales proportionally to population density $\rho$,
% coalescent times do as well,
% but possibly with a much smaller coefficient
% (due effectively to an increase in reproductive variance).


\paragraph{How then do substitutions occur?}
If it is rare for gene flow to rapidly spread selected alleles across a species range, 
how then do selected alleles ever become fixed within species? 
Drift alone will act only slowly to sort variants within species into
divergence among species. 
\plr{Of course, effective population sizes estimated from genetic diversity
    are nearly always small enough that fixation of neutral alleles by drift
    is expected to take less time than the divergence time between species.
    However, this observation is somewhat circular,
    and as reviewed by \citet{leffler2012revisiting},
    we do not understand why the implied ``effective population sizes'' differ so much
    from census population sizes;
    selective processes (as described here) are likely part of the explanation \citep{corbettdetig2015natural}.
}
\gc{Slight selective differences in the pleiotropic effects (or linked
  background) among convergent alleles could allow one allele to
  press into areas occupied by other alleles.}
Furthermore, repeated bouts of adaptation in particular genomic regions may act 
to push a subset of previously selected alleles to fixation across the
species range, through the spread of the genetic backgrounds on which
they arise.  
However, it seems likely that this is a slow process compared to the
initial rapid spread of selected alleles.
\
\paragraph{Speciation and extinction as phases of molecular evolution?}
One potential resolution is that many selected alleles achieve
fixation, not through their own species-wide spread, but rather
through subsequent large-scale changes in geographic range size
induced by extirpation of the species over parts of its range
\citep[see ][and references therein for how such a model could be constructed]{barton2013modelling}. 
Such drops in range size may fix, or radically change the species-wide frequency, 
of alleles previously restricted to small portion of a species range. 
Furthermore, many modes of speciation are proposed to occur through a
geographically-limited subset of populations forming the basis of new species, 
e.g.\ the splitting off of part of the range through a vicariance event 
or dispersal of a subset of individuals. 
In this case, speciation will cause geographic assortment of
polymorphic ancestral variation, again acting to fix variants within
newly formed species that were previously polymorphic across ancestral species ranges. 

Such ideas are not completely new and represent a perhaps logical consequence of
an allopatric or parapatric view of the biogeography of speciation.
However, it is worth revisiting this idea as geographically broad population genomic
sampling allows us to return to themes
in biogeography. 
Along similar lines, Futuyma has argued that much of the adaptive differentiation within species,
e.g.\ adaptation to local conditions, 
may be ephemeral and subject to loss due to local extinction and the mixing 
following the collapse of population structure \citep{Futuyma:10,FUTUYMA:87}. 
Futuyma offered this as an explanation of the pattern of punctuated equilibrium \citep{eldredgegould72}, 
and argued that the observation of stasis and rapid anagenesis associated with speciation 
were consistent with micro-evolution. 
Futuyma argued that despite rapid adaptation over short time-scales, we
may observe morphological stasis in the fossil record as much of this
adaptation is lost to local extinction and the collapse of population structure
\citep[see also][]{lieberman:96,Eldredge:05, Futuyma:10}. 
Furthermore, he suggests that speciation
may act as ratchet to prevent the loss of differentiation, acting to
maintain adaptive changes among populations, and prevent their loss by interbreeding. 
At face value the rate of species formation seems too low to contribute to this process. 
However, \citet{Rosenblum:12}, and many others, 
have argued that the rate of speciation may well be quite high,
but that the majority of incipient species do not persist long due to
reabsorption or extinction. 
Changes in range size, due to local extinction, can also be very rapid 
on the time-scales over which alleles may spread on the landscape \citep{gaston2003structure,HEWITT1996}.
Repeated bouts of extinction and speciation will send waves of alleles
to fixation along particular lineages. 
%Ranges change sufficiently rapidly that
%range size could change substantially over the sojourn time of most alleles 
%that will eventually become fixed in the species, making it likely that. 



%\plr{This paragraph, and some of the following, are a bit redundant with the above.}
%Futuyma and others have advanced these ideas mainly in the
%setting of adaptation to local conditions 
%\citep[particularly local communities ][]{} . 
%Much of the recent adaptation seen by
%population genetics may be adaptation to local conditions, 
%but as we have shown, even wide-spread selection pressures will likely result in 
%geographically restricted spread of alleles.
%The adaptive substitutions we see along lineages may be those alleles 
%simply lucky enough to have spread in local populations or incipient species that escaped extinction.

%Venditti:10, 
Such a link between speciation and substitution would not imply that
substitutions should necessarily be thought of as being clustered at splits in inferred phylogenies 
\citep[see ][for a recent exchange on this]{Pennell:14,Venditti:14,Pennell:14B}. 
Neutral substitutions are unaffected by this process, 
because they accumulate in a clocklike manner along lineages, 
as dictated by the mutation rate, 
regardless of the geographic details of their polymorphic stage. 
Turning to the accumulation of adaptive substitutions, 
it is likely that splits in phylogenies are only a tiny proportion of all incipient speciation events, 
because extinction rates may be high \citep{Rosenblum:12}, 
and so every lineage has likely passed through many ``speciation events'' in addition to the observed ones.
Under these assumptions,
spatial polymorphisms could accumulate gradually in geographically restricted populations
between the large-scale biogeographic events that cause their fixation or loss. 
This effectively decorrelates the time at which new alleles arise and when they fix in the species,
an effect similar to that pointed out by \citet{Gillespie:94}.

%Thus selected alleles that eventually become a
%substitutions may have arisen long before they reach fixation. 
 
This view would not imply that adaptive evolution or speciation is driven by the
shifting balance or genetic revolutions 
\citep{Wright:32, Mayr-genetic-revol:1954}, 
whereby genetic drift allows
populations to cross fitness valleys and substitute novel epistatic combinations. 
Although geographic lineage sorting via speciation and extinction 
can be thought of as very large-scale genetic drift events,
in the models we study here the initial spread of alleles is due to selection, not drift
\citep[see also ][for discussion]{Futuyma:89}. 

%The adaptive substitutions we see along lineages may be those alleles 
%simply lucky enough to have spread in local populations or incipient species that escaped extinction.

There is evidence that a reasonable fraction of genome-wide substitutions are fixed by positive selection in a number of species
\citep[most notably Drosophila, ][]{Sella:09}. 
Under the geographic view of fixation, 
selection has played a strong role in the establishment of these alleles locally. 
As we get more broadly geographic population genomics sampling for a range of species 
we will have the opportunity to study whether the class of alleles that contribute to local differentiation 
are similar to those underlying species divergence, 
and the extent to which the answer to this depends on the
age and type of population structure within species. 

Finally, we close by noting that range expansion and speciation 
are obviously not separate from adaptive differentiation. 
The invasion of new geographic areas may lead to a burst of adaptive differentiation, 
at least in a subset of genes, and speciation may be associated with rapidly adaption to novel environments. 
Conversely, if the geographic spread of adaptive alleles within ranges is slow 
\mfp{(e.g.\ if they only offer a local advantage or if they are selectively excluded)} 
this may allow Dobzhansky-Muller incompatibilities to arise within species, 
effectively offering a mechanism for hybrid incompatibilities to evolve in parapatry,
and fracturing the range \citep{Bank:12,Kondrashov:03,bierne2011coupling}. 
The alleles that act as components in many of the Dobzhansky-Muller incompatibilities studied to date 
are geographically restricted \citep[see][]{Cutter:12}. 
Therefore, it seems possible that populations within species may often be tending towards speciation, 
and that as outlined here that this may drive some proportion of molecular divergence.

\subsubsection*{Acknowledgements}
We thank Michael Turelli, Jon Seger, and the Coop lab for helpful
conversations. We thank Florence D\'ebarre, Douglas Futuyma, Michael   %Débarre
Whitlock, Molly Przeworski, and  Sam Yeaman for helpful comments on an
earlier version of the paper. All figures and calculations were
performed in R \citep{R_stats}. The figure color paletes were generated using
Karthik Ram's ``Wes Anderson'' R color palette \url{https://github.com/karthik/wesanderson}.

\bibliography{standing_patches_refs}

%\appendix

% %%%%%%%%%%%%
% \section{Integrals appearing in the text}
%     \label{apx:integrals}

% In the text at several points appear integrals of the form
% \begin{align}
%   \int_0^\infty t^c \exp \left( - \alpha t^d - \beta t^{d+1} \right) dt 
% \end{align}
% where $c$ is a positive integer, $d$ is the dimension, and $\alpha$ and $\beta$ are positive real numbers.
% This could be evaluated through standard numerical methods; below we describe a power series expansion.
% Changing variables to $u = \beta t^{d+1}$, this becomes
% \begin{align}
%     \left( (d+1)^{-1} \beta^{ (1-c)/(d+1) } \right) \int_0^\infty u^{(c+1-d)/(d+1)} \exp\left( - \alpha \beta^{-d/(d+1)} u^{d/(d+1)} - u \right) du ,
% \end{align}
% so it suffices to evaluate the function
% \begin{equation}
%     G(a,b,x) := \int_0^\infty  t^a \exp\left( -x t^b - t \right) dt ,
% \end{equation}
% in the case that $a=(c-d+1)/(d+1)$, $b=d/(d+1)$, and $x$ is a function of the demographic parameters.
% Since $a$ and $b$ only depend on the dimension and the quantity being computed,
% we are interested in $G$ as a function of $x$.
% At least in the case $b=d/(d+1)$ it is possible to express $G$ as a finite sum of gamma functions,
% but we proceed with a simpler method.
% Note that $\partial_x G(a,b,x) = -G(a+b,b,x)$,
% and that at $x=0$, the function $G$ is the gamma function $G(a,b,0) = \Gamma(a+1)$.
% Therefore, a Taylor series for $G$ would be
% \[
%     G(a,b,x) = \sum_{n \ge 0} \frac{(-x)^n}{n!} \Gamma(a+nb+1) .
% \]
% It is easy to check using Stirling's formula that $\limsup_{n \to \infty} ( x^n \Gamma(a+nb+1)/n! )^{1/n} = 0$
% if $b<1$, so the sum converges.


\end{document} 
